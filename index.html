<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <title>Vosklet Demo</title>
    <meta content="Lightweight and fast automatic speech recognition right in the browser! Available in 20 languages" name="description">
    <script src="coi-serviceworker.js"></script>

    <script crossorigin defer src="https://cdn.jsdelivr.net/gh/msqr1/Vosklet@1.2.1/Examples/Vosklet.js"></script>
    <link crossorigin href="https://cdn.jsdelivr.net/gh/msqr1/msqr1.github.io/favicon.ico" rel="icon" type="image/x-icon">
    
    <style>
        body { font-size: 1.3rem; box-sizing: border-box; }
        button, input, select { vertical-align: middle; font-size: 1rem; }
        #loadBtn { margin-right: 1.25rem; }
        #spkBtn { text-align: center; padding: 5px; }
        #micOff, #micOn { width: 1.6rem; height: 1.6rem; }
        #cacheTbl, #micOn { display: none; }
        #info, h1, h3 { text-align: center; }
        #info { margin: 0 0 3.5rem 0; }
        #result { border: 1px solid grey; width: 100%; overflow-wrap: break-word; min-height: 1.56rem; }
        #result > span { color: grey; }
        #flexbox { --gap: 1.5%; justify-content: center; display: flex; flex-wrap: wrap; column-gap: var(--gap); }
        #flexbox > div { width: 100%; }
        
        @media (width > 991px) {
            #flexbox > div { width: calc(50% - var(--gap) / 2); }
        }
        
        #flexbox > div > div { margin: 0 0 1.2rem 0; }
        table { background: #000; width: 100%; }
        td { background: #fff; }
        th { background: #d3d3d3; }
        .delete { text-align: center; }
        .delete:hover { background: #ffbdbd; }
    </style>
</head>

<body>
    <h1>Vosklet Browser ASR Demo (v1.2.1)</h1>
    <div id="info">
        <a href="https://github.com/msqr1/Vosklet">Github Repository</a> (Give a ðŸŒŸ if you enjoy!)
    </div>

    <div id="flexbox">
        <div>
            <h3>Speech Recognition</h3>
            <div>
                <label for="langPick">Language:</label>
                <select id="langPick">
                    <option value="vosk-model-small-en-us-0.15_">English</option>
                    <option value="vosk-model-small-en-in-0.4_">Indian English</option>
                    <option value="vosk-model-small-cn-0.3_">Chinese</option>
                    <option value="vosk-model-small-ru-0.4_">Russian</option>
                    <option value="vosk-model-small-fr-pguyot-0.3_">French</option>
                    <option value="vosk-model-small-de-0.15_">German</option>
                    <option value="vosk-model-small-ca-0.4_">Catalan</option>
                    <option value="vosk-model-small-pt-0.3_">Portuguese</option>
                    <option value="vosk-model-small-tr-0.3_">Turkish</option>
                    <option value="vosk-model-small-it-0.4_">Italian</option>
                    <option value="vosk-model-malayalam-bigram_">Malayam</option>
                    <option value="vosk-model-small-es-0.42">Spanish</option>
                    <option value="vosk-model-small-vn-0.4">Vietnamese</option>
                    <option value="vosk-model-small-nl-0.22">Dutch</option>
                    <option value="vosk-model-small-fa-0.5">Farsi</option>
                    <option value="vosk-model-small-kz-0.15">Kazakh</option>
                    <option value="vosk-model-small-ja-0.22">Japanese</option>
                    <option value="vosk-model-small-hi-0.22">Hindi</option>
                    <option value="vosk-model-small-cs-0.4-rhasspy">Czech</option>
                    <option value="vosk-model-small-uz-0.22">Uzbek</option>
                    <option value="vosk-model-small-ko-0.22">Korean</option>
                    <option value="vosk-model-small-tg-0.22">Tajik</option>
                </select>
                <button id="loadBtn">Load</button>
                <label for="cacheBtn">Show model cache:</label>
                <input autocomplete="off" id="cacheBtn" type="checkbox">
            </div>

            <div>
                <label for="spkBtn">Toggle microphone:</label>
                <button id="spkBtn" autocomplete="off" disabled>
                    <img crossorigin id="micOn" src="https://cdn.jsdelivr.net/gh/msqr1/msqr1.github.io/Vosklet/micOn.svg">
                    <img crossorigin id="micOff" src="https://cdn.jsdelivr.net/gh/msqr1/msqr1.github.io/Vosklet/micOff.svg">
                </button>
            </div>

            <div>
                <label for="uploadBtn">Upload audio:</label>
                <input autocomplete="off" id="uploadBtn" type="file" disabled multiple>
                <button id="processBtn" autocomplete="off" disabled>Process</button>
            </div>

            <div>
                <label for="clrBtn">Result text:</label>
                <button id="clrBtn">Clear</button>
            </div>

            <div id="result"><span></span></div>
        </div>

        <div id="cacheTbl">
            <h3>Cached Models</h3>
            <table>
                <thead>
                    <tr><th>Path</th><th>ID</th><th>Delete (click)</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        'use strict';
        
        let startup = async () => {
            var b = document.getElementById.bind(document);
            let d = document.getElementsByTagName("tbody")[0],
                E = b("cacheTbl"),
                x = b("cacheBtn"),
                y = b("langPick"),
                r = b("loadBtn"),
                l = b("uploadBtn"),
                t = b("processBtn"),
                f = b("spkBtn"),
                F = b("clrBtn"),
                g = b("micOn"),
                u = b("micOff"),
                m = b("result"),
                z = m.lastChild;

            let n = await loadVosklet();
            let w = await n.getModelCache();
            let e = new AudioContext({ sinkId: { type: "none" }, latencyHint: "interactive" });
            let A = await n.createTransferer(e, 19200);
            let B, p, c;
            let initialHtml = "";

            async function deleteModel() {
                await w.delete(this.parentNode.firstChild.textContent, { ignoreSearch: !0 });
                d.removeChild(this.parentNode);
            }

            let showPartial = a => z.textContent = " " + JSON.parse(a.detail).partial;
            let showResult = a => {
                z.textContent = "";
                m.textContent += " " + JSON.parse(a.detail).text;
            };

            var h = await w.keys();
            for (let a of h) {
                let parts = a.url.split("?");
                initialHtml += "<tr><td>" + parts[0].substring(parts[0].lastIndexOf("/")) + "</td><td>" + parts[1] + "</td><td class='delete'>[x]</td></tr>";
            }
            d.innerHTML += initialHtml;

            for (let a of document.getElementsByClassName("delete")) {
                a.addEventListener("click", deleteModel, { once: !0 });
            }

            A.port.onmessage = a => c.acceptWaveform(a.data);
            x.onchange = () => E.style.display = x.checked ? "block" : "none";
            F.onclick = () => m.textContent = "";

            t.onclick = async () => {
                for (let a of l.files) {
                    let k = await e.decodeAudioData(await a.arrayBuffer());
                    c.acceptWaveform(k.getChannelData(0));
                }
                l.value = null;
            };

            f.addEventListener("click", async () => {
                B = e.createMediaStreamSource(await navigator.mediaDevices.getUserMedia({
                    video: !1,
                    audio: { channelCount: 1 }
                }));
                B.connect(A);
                f.onclick = async () => {
                    if ("block" == g.style.display) {
                        g.style.display = "none";
                        u.style.display = "block";
                        await e.suspend();
                    } else {
                        u.style.display = "none";
                        g.style.display = "block";
                        await e.resume();
                    }
                };
                f.onclick();
            }, { once: !0 });

            r.onclick = async () => {
                if ("block" == g.style.display) {
                    g.style.display = "none";
                    u.style.display = "block";
                }
                await e.suspend();
                r.disabled = l.disabled = t.disabled = f.disabled = !0;

                let modelVal = y.value,
                    modelText = y.selectedOptions[0].text;
                
                var isLegacy = modelVal.endsWith("_");
                if (isLegacy) modelVal = modelVal.slice(0, -1);
                
                let modelUrl = "https://" + (isLegacy ? "ccoreilly.github.io/vosk-browser" : "msqr1.github.io/Vosklet") + "/models/" + modelVal + ".tar.gz";
                
                if (null != p) {
                    c.removeEventListener("result", showResult);
                    c.removeEventListener("partialResult", showPartial);
                    await c.delete();
                    p.delete();
                }

                p = await n.createModel(modelUrl, modelText, modelVal);
                
                // Add to cache table if not present
                let exists = false;
                for (let row of d.childNodes) {
                    if (modelText == row.firstChild.textContent) {
                        exists = true;
                        break;
                    }
                }
                if (!exists) {
                    d.innerHTML += "<tr><td>" + modelText + "</td><td>" + modelVal + "</td><td class='delete'>[x]</td></tr>";
                    d.lastChild.lastChild.addEventListener("click", deleteModel, { once: !0 });
                }

                c = await n.createRecognizer(p, e.sampleRate);
                c.addEventListener("result", showResult);
                c.addEventListener("partialResult", showPartial);
                r.disabled = l.disabled = t.disabled = f.disabled = !1;
            };
        };

        if ("loading" != document.readyState) startup();
        else document.addEventListener("DOMContentLoaded", startup);
    </script>
</body>
</html>
